#addlmhosts.rb

module Puppet::Parser::Functions
  newfunction(:addlmhosts, :type => :rvalue) do |args|
    Puppet::Parser::Functions.autoloader.loadall
#    require 'rubygems'
#    require 'json'
    existing_hosts = function_getlmhosts([])
    existing_groups = function_getlmgroups([])
    existing_collectors = function_getlmcollectors([])
    collector_nodes = function_getcollectornodes([])
    host_nodes = function_puppetdbget(["/resources", '["and", ["=", "type", "Class"], ["=", "title", "Logicmonitor::Host"]]'])
    rval = ""
    hosts = JSON.parse(host_nodes)

    hosts.each do |host|
      if collector_nodes.has_key?(host["parameters"]["collector"])

      elsif host["parameters"]["collector"].to_i != 0

      else
        rval << "Collector " + host["parameters"]["collector"] + " was not found. Skipping add.\n"
      end
    
    end
    return rval
  end
end
